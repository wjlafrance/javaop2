require 'ant'  
  
PROJECT_NAME = 'javaop2'

JARPATH = "jar"
PLUGINPATH = "#{JARPATH}/Plugins"

task :default => [:clean, :build, :jar, :test]
task :notests => [:clean, :build, :jar]

PLUGINS = ["Advertisements",
           "Alias",
           "AntiFlood",
           "AutoRejoin",
           "Autoban",
           "AwayMessage",
           "BNetLogin",
           "BnetEventProcess",
           "BasicCommands",
           "BotMail",
           "ChannelProtection",
           "ChannelList",
           "Commands",
           "ConnectionCommands",
           "ConsoleDisplay",
           "Designate",
           "EmailRegister",
           "Filters",
           "Forwarding",
           "FunStuff",
           "GlobalCommand",
           "Greeting",
           "Help",
           "IPBan",
           "Ladder",
           "Logging",
           "Moderation",
           "Ping",
           "Profile",
           "ShellCommands",
           "ShowInvisibleUsers",
           "StayConnected",
           "SweepBan",
           "SwingGui",
           "UserInformation",
           "UserManagement",
           "Version",
           "War3Clan"]


task :clean do
  ant.delete :dir => "javaop2/bin"
  ant.delete :dir => "hashes"
  ant.delete :dir => "#{PLUGINPATH}"
  PLUGINS.each do | plugin |
    ant.delete :dir => "#{plugin}/bin"
  end
  puts
end

    
task :build do
  ant.mkdir :dir => "javaop2/bin"
  ant.javac :srcdir => "javaop2/src",
            :destdir => "javaop2/bin",
            :includeantruntime => "no"
  
  PLUGINS.each do | plugin |
    ant.mkdir :dir => "#{plugin}/bin"
    ant.javac :srcdir => "#{plugin}/src",
              :destdir => "#{plugin}/bin",
              :classpath => "javaop2/bin",
              :includeantruntime => "no"
  end
end


task :jar do
  ant.delete :dir => "#{JARPATH}"
  ant.mkdir :dir => "#{JARPATH}"
  ant.mkdir :dir => "#{PLUGINPATH}"
          
  ant.jar(:jarfile => "#{JARPATH}/JavaOp2.jar", :basedir => "javaop2/bin") do | ant |
    ant.manifest do | ant |
      ant.attribute(:name => 'Main-Class', :value => "com.javaop._main.BotStart")
    end
  end
  ant.jar(:jarfile => "#{JARPATH}/CommandlineConfigure.jar", :basedir => "javaop2/bin") do | ant |
    ant.manifest do | ant |
      ant.attribute(:name => 'Main-Class', :value => "com.javaop._main.CommandlineConfigure")
    end
  end
  ant.jar(:jarfile => "#{JARPATH}/ConfigurePlugins.jar", :basedir => "javaop2/bin") do | ant |
    ant.manifest do | ant |
      ant.attribute(:name => 'Main-Class', :value => "com.javaop._main.ConfigurePlugins")
    end
  end
  
  PLUGINS.each do | plugin |
    ant.jar(:jarfile => "#{PLUGINPATH}/#{plugin}.jar", :basedir => "#{plugin}/bin") do | ant |
      ant.manifest do | ant |
        ant.attribute(:name => 'Main-Class', :value => "com.javaop.#{plugin}.PluginMain")
      end
    end
  end
end


task :test do
  if not File.exists?("junit.jar")
    system("wget https://github.com/downloads/KentBeck/junit/junit4.9b4.zip")
    system("unzip junit4.9b4.zip")
    system("mv junit4.9b4/junit-4.9b4.jar junit.jar")
    system("rm -rf junit4.9b4 junit4.9b4.zip")
  end

  system("unzip -u junit.jar -d javaop2/bin")
  
  ant.delete :dir => "UnitTests/bin"
  ant.mkdir :dir => "UnitTests/bin"
  
  ant.javac :srcdir => "UnitTests/src",
            :destdir => "UnitTests/bin",
            :includeantruntime => "no",
            :classpath => "javaop2/bin:BNetLogin/bin"
        
  classes = ["org.junit.runner.JUnitCore",
             "com.javaop.UnitTests.CheckRevisionUnitTest"]
  system("java -classpath javaop2/bin:BNetLogin/bin:UnitTests/bin #{classes.join(" ")}")
  ant.delete :dir => "javaop2/bin/junit"
end


task :run do
  system("java -jar jar/JavaOp2.jar")
end


task :gethashes do
  games = ["SSHR", "W2BN", "DSHR", "DRTL", "STAR", "D2DV", "D2XP", "JSTR", "WAR3"]
  
  ant.delete :dir => "hashes"
  ant.mkdir :dir => "hashes"
  
  games.each do | game |
    system("curl http://realityripple.com/Software/Battle.net/Hash_Files/download.php?f=#{game} -o hashes/#{game}.zip")
    system("unzip hashes/#{game}.zip -d hashes/#{game}")
    system("rm hashes/#{game}.zip")
  end
end
